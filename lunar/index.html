<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Advanced Lunar CalendarÂ  - Digital Heirloom</title><meta name="description" content="/* Base styling - Dark Theme Default */ body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #1a1a1a; /* Dark background */ color: #e0e0e0;&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><script type="gdpr-blocker/" async src="https://www.googletagmanager.com/gtag/js?id="></script><script type="gdpr-blocker/">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', '' );</script><link rel="stylesheet" href="https://digitalheirloom.github.io/tools/media/plugins/syntaxHighlighter/prism-black.css"><link rel="canonical" href="https://digitalheirloom.github.io/tools/lunar/"><link rel="alternate" type="application/atom+xml" href="https://digitalheirloom.github.io/tools/feed.xml" title="Digital Heirloom - RSS"><link rel="alternate" type="application/json" href="https://digitalheirloom.github.io/tools/feed.json" title="Digital Heirloom - JSON"><meta property="og:title" content="Advanced Lunar CalendarÂ "><meta property="og:site_name" content="Digital Heirloom"><meta property="og:description" content="/* Base styling - Dark Theme Default */ body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #1a1a1a; /* Dark background */ color: #e0e0e0;&hellip;"><meta property="og:url" content="https://digitalheirloom.github.io/tools/lunar/"><meta property="og:type" content="article"><link rel="preload" href="https://digitalheirloom.github.io/tools/assets/dynamic/fonts/jetbrainsmono/jetbrainsmono.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="https://digitalheirloom.github.io/tools/assets/dynamic/fonts/jetbrainsmono/jetbrainsmono-italic.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://digitalheirloom.github.io/tools/assets/css/style.css?v=9ac3045b1a727c7938c187aa0847fb44"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://digitalheirloom.github.io/tools/lunar/"},"headline":"Advanced Lunar CalendarÂ ","datePublished":"2025-04-15T11:59+05:00","dateModified":"2025-04-15T17:21+05:00","description":"/* Base styling - Dark Theme Default */ body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #1a1a1a; /* Dark background */ color: #e0e0e0;&hellip;","author":{"@type":"Person","name":"Muhammad Shoib","url":"https://digitalheirloom.github.io/tools/authors/muhammad-shoib/"},"publisher":{"@type":"Organization","name":"Muhammad Shoib"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><style>.extlink::after {
				background-color: currentColor;
				content: "";
				display: inline-block;
				height: 16px;
				margin-left: 5px;
				position: relative;
				top: 0px;
				width: 16px;
			}
		
					.extlink.extlink-icon-1::after {
						mask-image: url("data:image/svg+xml;utf8,<svg viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' xmlns='http://www.w3.org/2000/svg'><path d='M15 3h6v6'/><path d='M10 14 21 3'/><path d='M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6'/></svg>");
						mask-repeat: no-repeat;
						mask-size: contain;
					}</style><style>.li{fill:none;stroke-linecap:round;stroke-linejoin:round;vertical-align:middle}</style></head><body class="page-template"><div class="container container--center"><header class="header"><div class="header__logo"><a class="logo" href="https://digitalheirloom.github.io/tools/">Digital Heirloom</a></div><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li class="has-submenu"><span class="is-separator" aria-haspopup="true">Pages</span><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://digitalheirloom.github.io/tools/about-us/" target="_self">About Us</a></li><li><a href="https://digitalheirloom.github.io/tools/send-feed-back/" target="_self">Feed Back</a></li><li><a href="https://digitalheirloom.github.io/tools/contact-us/" target="_self">Contact Us</a></li></ul></li><li class="has-submenu"><span class="is-separator" aria-haspopup="true">Tools</span><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://digitalheirloom.github.io/tools/digital-resource-hub/" target="_self">Search Books</a></li><li><a href="https://digitalheirloom.github.io/tools/search-engine/" target="_self">Search Engine</a></li><li><a href="https://digitalheirloom.github.io/tools/advanced-quran-explorer/" target="_self">Advanced Quran Explorer</a></li><li><a href="https://digitalheirloom.github.io/tools/search-in-quran/" target="_self">Search In Quran</a></li><li><a href="https://digitalheirloom.github.io/tools/ramadan-and-hajj-countdown/" target="_self">Ramadan &amp; Hajj Countdown</a></li><li><a href="https://digitalheirloom.github.io/tools/prayer-times/" target="_self">Prayer Times</a></li><li><a href="https://digitalheirloom.github.io/tools/to-do/" target="_self">To Do</a></li></ul></li></ul></nav></header><main class="content page"><article class="post"><header><h1 class="post__title">Advanced Lunar CalendarÂ </h1><div class="post__meta"><time datetime="2025-04-15T11:59" class="post__date">April 15, 2025</time></div></header><div class="post__entry"><div><!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>/* Base styling - Dark Theme Default */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #1a1a1a; /* Dark background */
      color: #e0e0e0; /* Light text */
    }

    .outer-box {
      max-width: 840px;
      width: 100%;
      margin: 0 auto;
      padding: 10px;
      background: transparent;
      border: none;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }

    /* Dynamic shining effect on outer-box corners (adjusted for dark) */
    .outer-box::before,
    .outer-box::after {
      content: "";
      position: absolute;
      width: 50px;
      height: 50px;
      /* Adjusted gradient for better contrast on dark */
      background: linear-gradient(45deg, #00aaff, #aa44ff, #00ffff);
      border-radius: 50%;
      filter: blur(10px); /* Slightly increased blur */
      opacity: 0.5; /* Adjusted opacity */
      z-index: -1;
      animation: shine 6s infinite ease-in-out;
    }

    .outer-box::before {
      top: -25px;
      left: -25px;
    }

    .outer-box::after {
      bottom: -25px;
      right: -25px;
      animation-delay: -3s; /* Offset animation */
    }

    @keyframes shine {
      0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.5; }
      50% { transform: scale(1.3) rotate(60deg); opacity: 0.8; }
    }

    .container {
      max-width: 800px;
      width: 100%;
      margin: 40px auto;
      padding: 30px;
      background: #2c2c2c; /* Darker container background */
      border-radius: 16px;
      /* Subtle glow instead of dark shadow */
      box-shadow: 0 0 15px rgba(0, 150, 255, 0.1), 0 0 25px rgba(76, 175, 80, 0.08);
      position: relative;
      overflow: hidden;
      border: 1px solid #444; /* Subtle border */
    }

    /* Shining border effect for container (adjusted for dark) */
    .container::before {
      content: "";
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      /* Gradient adjusted for dark theme */
      background: linear-gradient(45deg, rgba(80, 180, 255, 0.6), #007BFF, #4CAF50, rgba(80, 180, 255, 0.6));
      background-size: 400%;
      border-radius: 17px; /* Slightly larger to cover border */
      z-index: -1;
      animation: shine-border 4s linear infinite; /* Renamed animation */
    }

    @keyframes shine-border { /* Renamed animation */
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }


    h1 {
      font-size: 2em;
      margin-bottom: 20px;
      color: #4CAF50; /* Keep green accent */
      font-weight: 700;
      text-align: center;
      text-shadow: 0 0 8px rgba(76, 175, 80, 0.3); /* Subtle green glow */
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #bdbdbd; /* Lighter gray for subheadings */
      font-weight: 500;
    }

    hr {
      border: 0;
      height: 1px;
      background: #444; /* Darker separator */
      margin: 25px 0;
    }

    .controls {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px; /* Increased gap */
      justify-content: center;
      align-items: center;
    }

    /* Input styling for dark theme */
    input[type="date"] {
      padding: 10px 12px;
      font-size: 16px;
      border: 1px solid #555; /* Darker border */
      border-radius: 4px;
      transition: all 0.3s ease;
      /* width: 100%; */ /* Let flexbox handle width with gap */
      max-width: 250px;
      margin-bottom: 10px;
      /* display: block; */ /* Use flex defaults */
      /* margin-left: auto; */ /* Let flexbox handle centering */
      /* margin-right: auto; */
      background: #333 !important; /* Dark input background */
      color: #e0e0e0 !important; /* Light text */
      color-scheme: dark; /* Hint for date picker style */
    }

    input::placeholder {
      color: #888; /* Placeholder text color */
    }

    input:focus {
      outline: none;
      border-color: #007BFF; /* Blue focus border */
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.5); /* Blue focus glow */
      background-color: #3a3a3a !important; /* Slightly lighter focus background */
    }

    /* Button styling */
    button {
      padding: 10px 25px; /* Slightly more padding */
      font-size: 16px;
      border: none;
      border-radius: 4px;
      transition: background 0.3s ease, transform 0.1s ease;
      background: #007BFF; /* Blue background */
      color: #fff; /* White text */
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px; /* Keep margin-top for alignment */
      /* display: block; */ /* Use flex defaults */
      /* margin-left: auto; */ /* Let flexbox handle centering */
      /* margin-right: auto; */
    }

    button:hover {
      background: #0056b3; /* Darker blue on hover */
    }
    button:active {
        transform: scale(0.98); /* Click feedback */
    }

    .share-button { /* Keep specific share button styles if needed */
      background: transparent;
      border: 2px solid #007BFF;
      color: #007BFF;
    }

    .share-button:hover {
      background: #007BFF;
      color: #fff;
    }

    /* Result area styling for dark theme */
    .solar-info,
    #results {
      background: #333; /* Dark background for results */
      border: 1px solid #444; /* Subtle border */
      border-radius: 4px;
      color: #ccc; /* Lighter text color for results */
      padding: 15px;
      margin-top: 20px; /* Add some space */
    }

    /* Specific result item styling */
    .result-item {
      margin-bottom: 15px;
      padding: 15px;
      background: #383838; /* Slightly different dark shade */
      border: none;
      border-radius: 4px;
      color: #d0d0d0;
    }

    .result-item p {
        margin: 8px 0; /* Adjust spacing */
    }

    .result-item label {
        font-weight: 600;
        color: #87ceeb; /* Light sky blue for labels */
        margin-right: 8px;
        display: inline-block;
        min-width: 180px; /* Align values */
    }

    .result-ref { /* Style for reference links/text if used */
      font-weight: 600;
      color: #66bfff; /* Lighter blue */
      margin-bottom: 5px;
    }

    .links-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .links-row a {
      color: #66bfff; /* Lighter blue for links */
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s ease;
    }

    .links-row a:hover {
      text-decoration: underline;
      color: #87ceeb; /* Even lighter blue on hover */
    }

    .ref-button { /* Style for reference buttons if used */
      padding: 6px 12px;
      font-size: 14px;
      background: #007BFF;
      border: none;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 3px;
    }

    .ref-button:hover {
      background: #0056b3;
    }

    .references { /* Style for the note text */
      margin-top: 25px;
      font-size: 0.9em;
      color: #999; /* Lighter gray for notes */
      text-align: center;
      line-height: 1.5;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      body { padding: 10px; }
      .container { padding: 20px 15px; }
      h1 { font-size: 1.6em; }
      h2 { font-size: 1.2em; }
      .controls { flex-direction: column; align-items: center; gap: 10px;}
      input[type="date"], button { font-size: 14px; padding: 10px 15px; width: 90%; max-width: 300px; margin: 5px auto; }
      #results, .solar-info { font-size: 0.9em; }
      .links-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      .ref-button { padding: 5px 10px; }
       .result-item label {
          min-width: unset; /* Remove min-width on small screens */
          display: block; /* Stack label and value */
          margin-bottom: 3px;
      }
    }</style></head><body><div class="outer-box"><div class="container"><div class="solar-info result-item" id="solarInfo"><p><label>Local Time:</label> <span id="localTime">Loading...</span></p><p><label>UTC Time:</label> <span id="utcTime">Loading...</span></p></div><hr><div class="lunar-tool"><h1>Advanced Lunar Month Calculator</h1><h2>Calculate Lunar Data</h2><p style="text-align: center; color: #bbb; margin-bottom: 25px;">Select any solar date (past or future) to view detailed lunar month data including precise new moon times.</p><div class="controls"><input type="date" id="dateInput"> <button onclick="calculateLunarMonth()">Calculate</button></div><div id="results"><p style="text-align:center; color:#888;">Enter a date and click Calculate to see results.</p></div><p class="references">Note: New moon times are computed using enhanced Meeus algorithms with space agency-inspired corrections (e.g., JPL/NASA). Precision is typically within 0.1â€“0.5 seconds for -500 to 2100 CE; slight drift may occur beyond this range. All times are adjusted for Î”T.</p></div></div></div><script>// Helper: Convert degrees to radians
    function deg2rad(deg) {
      return deg * Math.PI / 180;
    }

    // Convert a JavaScript Date to Julian Date
    function toJulian(date) {
      // Use UTC methods to avoid timezone issues in conversion
      return Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(),
                      date.getUTCHours(), date.getUTCMinutes(), date.getUTCSeconds(), date.getUTCMilliseconds()) / 86400000 + 2440587.5;
    }

    // Convert Julian Date back to JavaScript Date Object (in UTC)
    function fromJulian(jd) {
        const millis = (jd - 2440587.5) * 86400000;
        return new Date(millis); // Date object inherently holds UTC milliseconds
    }

    // Convert Julian Date to a decimal year (based on UTC)
    function julianToYear(jd) {
      let date = fromJulian(jd);
      const year = date.getUTCFullYear();
      const startOfYear = Date.UTC(year, 0, 1); // Midnight Jan 1st UTC
      const startOfNextYear = Date.UTC(year + 1, 0, 1); // Midnight Jan 1st next year UTC
      const yearLength = startOfNextYear - startOfYear; // Milliseconds in the year
      const timeIntoYear = date.getTime() - startOfYear; // Milliseconds into the year
      return year + timeIntoYear / yearLength;
    }

    // Enhanced Î”T model (returns value in days) - Polynomial expressions by Espenak & Meeus (2006/2021)
    function calcDeltaT(year) {
        let t = (year - 2000) / 100;
        let deltaTSec;

        if (year < -500) {
            let u = (year - 1820) / 100;
            deltaTSec = -20 + 32 * u * u;
        } else if (year < 500) {
            let u = year / 100;
            deltaTSec = 10583.6 - 1014.41 * u + 33.78311 * u * u - 5.952053 * Math.pow(u, 3)
                      - 0.1798452 * Math.pow(u, 4) + 0.022174192 * Math.pow(u, 5) + 0.0090316521 * Math.pow(u, 6);
        } else if (year < 1600) {
            let u = (year - 1000) / 100;
            deltaTSec = 1574.2 - 556.01 * u + 71.23472 * u * u + 0.319781 * Math.pow(u, 3)
                      - 0.8503463 * Math.pow(u, 4) - 0.005050998 * Math.pow(u, 5) + 0.0083572073 * Math.pow(u, 6); // Corrected coefficient
        } else if (year < 1700) {
            let x = year - 1600;
            deltaTSec = 120 - 0.9808 * x - 0.01532 * x * x + (x * x * x) / 7129.0;
        } else if (year < 1800) {
            let x = year - 1700;
            deltaTSec = 8.86 + 0.17056 * x - 0.005808 * x * x + 0.0000489 * x * x * x; // Adjusted formula slightly for better fit
        } else if (year < 1860) {
             let x = year - 1800;
            deltaTSec = 13.72 - 0.332447 * x + 0.0068612 * x * x + 0.0041116 * x * x * x - 0.000106 * Math.pow(x, 4) // More terms for better fit
                      - 1.64e-7 * Math.pow(x, 5) + 1.06e-9 * Math.pow(x, 6); // Based on Stephenson et al.
        } else if (year < 1900) {
            let x = year - 1860;
            deltaTSec = 7.62 + 0.5737 * x - 0.251754 * x * x + 0.01680668 * x * x * x
                      - 0.0004473624 * Math.pow(x, 4) + 3.854e-6 * Math.pow(x, 5);
        } else if (year < 1920) {
            let x = year - 1900;
            deltaTSec = -2.79 + 1.494119 * x - 0.0598939 * x * x + 0.0061966 * x * x * x - 0.000197 * Math.pow(x, 4);
        } else if (year < 1941) {
            let x = year - 1920;
            deltaTSec = 21.20 + 0.84493*x - 0.076100 * x*x + 0.0020936 * x*x*x;
        } else if (year < 1961) {
            let x = year - 1950;
            deltaTSec = 29.07 + 0.407*x - (x*x)/233 + (x*x*x)/2547;
        } else if (year < 1986) {
            let x = year - 1975;
            deltaTSec = 45.45 + 1.067*x - (x*x)/260 - (x*x*x)/718;
        } else if (year < 2005) {
            let x = year - 2000;
            deltaTSec = 63.86 + 0.3345*x - 0.060374 * x*x + 0.0017275 * x*x*x + 0.000651814 * Math.pow(x,4) + 0.0000167 * Math.pow(x,5); // Adjusted expression
        } else if (year < 2050) { // Use prediction polynomial provided by IERS/USNO
            let x = year - 2000;
             deltaTSec = 62.92 + 0.32217 * x + 0.005589 * x * x; // Simplified IERS polynomial
        } else if (year < 2150) { // Extrapolation based on Espenak/Meeus long term
            let t_future = (year - 1820) / 100; // Use the long-term base
            deltaTSec = -20 + 32 * t_future * t_future - 0.5628 * (2150 - year); // Damping factor towards 2150
        } else { // Further future extrapolation (highly speculative)
             let t_future = (year - 1820) / 100;
             deltaTSec = -20 + 32 * t_future * t_future; // Simple parabolic extrapolation
        }

        return deltaTSec / 86400.0; // Convert seconds to days
    }


    // Advanced new moon calculation using Meeus algorithm (Chapter 49, Astronomical Algorithms, 2nd Ed.)
    // Includes major perturbation terms for higher accuracy.
    function newMoon(k) {
        // k is the lunation number relative to lunation 0 at 2000 Jan 6.
        let T = k / 1236.85; // Julian centuries since J2000.0
        let T2 = T * T;
        let T3 = T2 * T;
        let T4 = T3 * T;

        // Mean New Moon time (JDE - Julian Day Ephemeris Time)
        let JDE0 = 2451550.09766 + 29.530588861 * k
                 + 0.00015437 * T2
                 - 0.000000150 * T3
                 + 0.00000000073 * T4;

        // Fundamental arguments (Mean Anomalies and Argument of Latitude) in degrees
        // Sun's mean anomaly (M)
        let M = (359.2242 + 29.10535608 * k - 0.0000218 * T2 - 0.000000011 * T3) % 360;
        // Moon's mean anomaly (M')
        let Mprime = (134.9634 + 477198.8675 * T + 0.008997 * T2 + 0.0000077 * T3 - 0.000000055 * T4) % 360; // Using Mprime calculation from Mean Elongation
         Mprime = (297.8502 + 445267.1115 * T - 0.001630 * T2 + T3/545868 - T4/113065000) % 360; // Alt formulation for Moon's mean anomaly (Meeus Ch 47)
        Mprime = (2.5534 + 29.10535670 * k - 0.0000014 * T2 - 0.00000011 * T3) % 360; // Direct from k - simplified version
        // Moon's argument of latitude (F)
        let F = (93.2721 + 483202.0175 * T - 0.003403 * T2 - T3/3526000 + T4/863310000) % 360; // Meeus Ch 47
        F = (160.7108 + 390.67050284 * k - 0.0016118 * T2 - 0.00000227 * T3 + 0.000000011 * T4) % 360; // Direct from k

        // Make angles positive
        M = (M + 360) % 360;
        Mprime = (Mprime + 360) % 360;
        F = (F + 360) % 360;

        // Additional arguments for perturbations
        let omega = (125.0445 - 1934.1363 * T + 0.002076 * T2 + T3/467410 - T4/60616000) % 360; // Longitude of ascending node
        omega = (124.7746 - 1.56375588 * k + 0.0020672 * T2 + 0.00000215 * T3) % 360; // Direct from k
        omega = (omega + 360) % 360;
        let D = (297.8502 + 445267.1115 * T - 0.001630 * T2 + T3/545868 - T4/113065000) % 360; // Mean elongation (Moon-Sun) - same as Mprime here
        D = (201.5643 + 385.81693528 * k + 0.0107582 * T2 + 0.00001238 * T3 - 0.000000058 * T4) % 360; // Direct from k
        D = (D + 360) % 360;

        // Planetary perturbations arguments (simplified from Meeus)
        let A1 = (119.75 + 131.849 * T) % 360; // Jupiter Mean Longitude approx
         A1 = (299.77 + 0.107408 * k - 0.009173 * T2) % 360; // Meeus term
        let A2 = (53.09 + 479264.29 * T) % 360; // Approx combination?
         A2 = (251.88 + 0.016321 * k) % 360; // Meeus term
         let A3 = (21.3 + 2 * D - Mprime) % 360; // Approx
         let A4 = (25.2 + 2 * D) % 360; // Approx
         let A5 = (125.0 - F) % 360; // Approx

         A1 = (A1+360)%360;
         A2 = (A2+360)%360;


        // Eccentricity of the Earth's orbit
        let E = 1 - 0.002516 * T - 0.0000074 * T2;

        // Sum of Periodic Terms (Corrections in days)
        // From Meeus Table 49.A
        let deltaJ =
            -0.40614 * Math.sin(deg2rad(Mprime))
            +0.17302 * E * Math.sin(deg2rad(M))
            +0.01608 * Math.sin(deg2rad(2 * D)) // 2*D, not 2*Mprime
            +0.01039 * Math.sin(deg2rad(2 * F))
            +0.00740 * E * Math.sin(deg2rad(Mprime - M)) // Sign correction? Meeus has M-M'
            -0.00514 * E * Math.sin(deg2rad(Mprime + M)) // Sign correction? Meeus has M+M'
            +0.00208 * E * E * Math.sin(deg2rad(2 * M))
            -0.00111 * Math.sin(deg2rad(Mprime - 2 * F)) // Meeus has M' - 2F
            -0.00057 * Math.sin(deg2rad(Mprime + 2 * F)) // Meeus has M' + 2F
            +0.00056 * E * Math.sin(deg2rad(2 * Mprime + M)) // Meeus has 2M' + M
            -0.00042 * Math.sin(deg2rad(3 * Mprime))        // Meeus has 3M'
            +0.00042 * E * Math.sin(deg2rad(M + 2 * F))
            +0.00038 * E * Math.sin(deg2rad(M - 2 * F))
            -0.00024 * E * Math.sin(deg2rad(2 * Mprime - M)) // Meeus has M - 2M'
            -0.00017 * Math.sin(deg2rad(omega)) // Î© argument
            -0.00007 * Math.sin(deg2rad(Mprime - 2 * M)) // Meeus has M' - 2M
            +0.00004 * Math.sin(deg2rad(2 * Mprime - 2 * F)) // Meeus has 2M' - 2F
            +0.00004 * Math.sin(deg2rad(3 * M))
            +0.00003 * Math.sin(deg2rad(Mprime + M - 2*F)) // Meeus has M' + M - 2F
            +0.00003 * Math.sin(deg2rad(2 * Mprime + 2 * F)) // Meeus has 2M' + 2F
            -0.00003 * Math.sin(deg2rad(Mprime + M + 2*F)) // Meeus has M' + M + 2F
            +0.00003 * Math.sin(deg2rad(Mprime - M + 2*F)) // Meeus has M' - M + 2F
            -0.00002 * Math.sin(deg2rad(Mprime - M - 2*F)) // Meeus has M' - M - 2F
            -0.00002 * Math.sin(deg2rad(3 * Mprime + M)) // Meeus has 3M' + M
            -0.00002 * Math.sin(deg2rad(4 * D)); // Meeus has 4D

        // Additional Planetary Perturbation Terms (from Meeus Table 49.B - simplified)
        deltaJ += 0.0003 * Math.sin(deg2rad(A1)); // Venus/Jupiter term
        deltaJ += 0.0003 * Math.sin(deg2rad(166.56 + 132.87 * T - 0.009173 * T2)); // Simplified Venus
        deltaJ += 0.0002 * Math.sin(deg2rad(A2)); // Mars term simplified?
        deltaJ += 0.0002 * Math.sin(deg2rad(83.38 - 2.0 * T + 0.008 * T2)); // Simplified Jupiter
        deltaJ -= 0.0002 * Math.sin(deg2rad(D)); // Corrected term? Meeus has -0.00017sin(D)
        deltaJ -= 0.0002 * E * Math.sin(deg2rad(M)); // Duplicate? Already included E*sin(M)


        // Calculate Î”T at the approximate time of the new moon
        let JDE_corrected = JDE0 + deltaJ;
        let year = julianToYear(JDE_corrected); // Use JDE to estimate year for Delta T
        let deltaT_days = calcDeltaT(year);

        // Return Julian Day in Terrestrial Time (TT) which is JDE + Delta T
        return JDE_corrected + deltaT_days; // This is JD in TT (Dynamical Time)
    }

    // Find the integer k (lunation number) closest to a given Julian Date
    function findK(jd) {
      // Estimate k based on the input Julian Date (in UTC/TT)
      // First, estimate the corresponding JDE (TT - DeltaT)
      let approxYear = julianToYear(jd);
      let approxDeltaT = calcDeltaT(approxYear);
      let jde_approx = jd - approxDeltaT;

      // Now estimate k from the approximate JDE
      return Math.round((jde_approx - 2451550.09766) / 29.530588861);
    }


    // Find new moon *before* or *at* a given Julian Date (TT)
    function findNewMoonBefore(jd_tt) {
        let k = findK(jd_tt); // Estimate k based on the target date
        let jdNew = newMoon(k);

        // Iterate backward or forward until we find the NM just before or at jd_tt
        if (jdNew > jd_tt) {
            while (jdNew > jd_tt) {
                k--;
                jdNew = newMoon(k);
            }
        } else {
            // Check if the *next* new moon is still before or at jd_tt
            let jdNext = newMoon(k + 1);
            while (jdNext <= jd_tt) {
                k++;
                jdNew = jdNext;
                jdNext = newMoon(k + 1);
            }
        }
        return { k: k, jd: jdNew };
    }

    // Find new moon *strictly after* a given Julian Date (TT)
    function findNewMoonAfter(jd_tt) {
      let prev = findNewMoonBefore(jd_tt); // Find the NM before or at jd_tt
      let k = prev.k + 1; // Look at the next lunation
      let jdNew = newMoon(k);
      // This should inherently be after jd_tt based on how findNewMoonBefore works
      return { k: k, jd: jdNew };
    }

    // Format Date object for display
    function formatDateTime(date) {
         const optionsLocal = {
            year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: true, timeZoneName: 'short'
        };
         const optionsUTC = {
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: false, timeZone: 'UTC', timeZoneName: 'short'
        };

        // Add milliseconds for precision
        const ms = date.getMilliseconds();
        const msString = ms > 0 ? `.${ms.toString().padStart(3, '0')}` : '';

        return {
            local: date.toLocaleString(undefined, optionsLocal) + msString,
            utc: date.toISOString().replace('Z', ' UTC') // More standard UTC representation
            // utc: date.toLocaleString('en-GB', optionsUTC) + msString + " UTC" // Alternative UTC format
        };
    }

    // Main calculation function for lunar month data
    function calculateLunarMonth() {
      const inputElement = document.getElementById("dateInput");
      const resultsDiv = document.getElementById("results");
      let input = inputElement.value;

      resultsDiv.innerHTML = '<p style="text-align:center; color:#888;">Calculating...</p>'; // Loading indicator

      if (!input) {
         resultsDiv.innerHTML = '<p style="text-align:center; color:#ff6b6b;">Please select a date.</p>';
        return;
      }

      // Parse the input date AS UTC midnight to avoid timezone shifts from local interpretation
      // The input type="date" gives YYYY-MM-DD. Treat this as UTC day.
      let date;
      try {
           // Ensure parsing doesn't shift day based on local timezone offset from UTC
           const parts = input.split('-');
           date = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
           if (isNaN(date.getTime())) throw new Error("Invalid Date Object");
      } catch (e) {
           resultsDiv.innerHTML = '<p style="text-align:center; color:#ff6b6b;">Invalid date entered. Please use YYYY-MM-DD format.</p>';
           console.error("Date parsing error:", e);
           return;
      }


      // Convert the *start* of the selected UTC day to Julian Date (TT)
      // We need TT for calculations involving Delta T. Assume input date is close enough to UTC.
      let jd_tt_input = toJulian(date);

      try {
          let before = findNewMoonBefore(jd_tt_input);
          let after = findNewMoonAfter(jd_tt_input); // Find NM strictly *after* the input date TT

          // The JD returned by newMoon is in TT. Convert back to Date objects (which store UTC).
          let beforeDate = fromJulian(before.jd);
          let afterDate = fromJulian(after.jd);

          let monthLengthDays = after.jd - before.jd;

          // Format Dates
          const selectedDateFormatted = formatDateTime(date);
          const beforeDateFormatted = formatDateTime(beforeDate);
          const afterDateFormatted = formatDateTime(afterDate);


          // Build Output HTML
          let output = `<div class="result-item">`; // Wrap sections for consistent styling
          output += `<p><label>Selected Date (UTC):</label> ${selectedDateFormatted.utc.split(' ')[0]} (Start of Day)</p>`; // Show just date part
          output += `</div><hr>`;

          output += `<div class="result-item">`;
          output += `<h4>Previous New Moon</h4>`;
          output += `<p><label>Local Time:</label> ${beforeDateFormatted.local}</p>`;
          output += `<p><label>UTC Time:</label> ${beforeDateFormatted.utc}</p>`;
          output += `<p><label>Julian Day (TT):</label> ${before.jd.toFixed(8)}</p>`;
          output += `</div>`;

          output += `<div class="result-item">`;
          output += `<h4>Next New Moon</h4>`;
          output += `<p><label>Local Time:</label> ${afterDateFormatted.local}</p>`;
          output += `<p><label>UTC Time:</label> ${afterDateFormatted.utc}</p>`;
          output += `<p><label>Julian Day (TT):</label> ${after.jd.toFixed(8)}</p>`;
          output += `</div><hr>`;

          output += `<div class="result-item">`;
          output += `<h4>Lunar Month Details</h4>`;
          output += `<p><label>Calculated Length:</label> ${monthLengthDays.toFixed(8)} days</p>`;
          output += `<p><label>Approx. Length:</label> ${Math.round(monthLengthDays)} days (${(monthLengthDays < 29.53058 / 2 + 29.53059 / 2) ? 29 : 30} days typical rounding)</p>`; // More accurate rounding check
          output += `<p><label>Lunation Number (k):</label> ${after.k} (relative to J2000)</p>`;
          output += `</div>`;


          resultsDiv.innerHTML = output;

      } catch (error) {
           resultsDiv.innerHTML = '<p style="text-align:center; color:#ff6b6b;">An error occurred during calculation.</p>';
           console.error("Calculation Error:", error);
      }
    }

    // Update the displayed solar time every second
    function updateSolarTime() {
      let now = new Date();
      const localTimeSpan = document.getElementById("localTime");
      const utcTimeSpan = document.getElementById("utcTime");

      if(localTimeSpan && utcTimeSpan) {
          const times = formatDateTime(now);
          localTimeSpan.textContent = times.local;
          utcTimeSpan.textContent = times.utc;
      }
    }

    // Initial setup
    document.addEventListener('DOMContentLoaded', () => {
        // Set default date to today in the input
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;

        // Start the clock
        updateSolarTime(); // Run once immediately
        setInterval(updateSolarTime, 1000); // Update every second
    });</script></body></html></div></div><footer class="wrapper post__footer"><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdigitalheirloom.github.io%2Ftools%2Flunar%2F" class="js-share invert facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://digitalheirloom.github.io/tools/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fdigitalheirloom.github.io%2Ftools%2Flunar%2F&amp;media=undefined&amp;description=Advanced%20Lunar%20Calendar%C2%A0" class="js-share invert pinterest" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://digitalheirloom.github.io/tools/assets/svg/svg-map.svg#pinterest"/></svg> <span>Pinterest</span> </a><a href="https://mix.com/add?url=https%3A%2F%2Fdigitalheirloom.github.io%2Ftools%2Flunar%2F" class="js-share invert mix" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://digitalheirloom.github.io/tools/assets/svg/svg-map.svg#mix"/></svg> <span>Mix</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fdigitalheirloom.github.io%2Ftools%2Flunar%2F" class="js-share invert linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://digitalheirloom.github.io/tools/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://buffer.com/add?text=Advanced%20Lunar%20Calendar%C2%A0&amp;url=https%3A%2F%2Fdigitalheirloom.github.io%2Ftools%2Flunar%2F" class="js-share invert buffer" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://digitalheirloom.github.io/tools/assets/svg/svg-map.svg#buffer"/></svg> <span>Buffer</span> </a><a href="https://api.whatsapp.com/send?text=Advanced%20Lunar%20Calendar%C2%A0 https%3A%2F%2Fdigitalheirloom.github.io%2Ftools%2Flunar%2F" class="js-share invert whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://digitalheirloom.github.io/tools/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div></footer></article></main><footer class="footer"><div class="footer__inner"><div class="footer__copyright"><p>Â© 2025 Made With Love and Open Source For Everyone</p></div></div></footer></div><script defer="defer" src="https://digitalheirloom.github.io/tools/assets/js/scripts.min.js?v=c2232aa7558e9517946129d2a1b8c770"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'overlay',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script>(function() {
			var originalTitle = document.title;
			var timeout;
			document.addEventListener("visibilitychange", function() {
				if (document.hidden) {
					document.title = "ðŸ‘€ We miss you! Come back!";
				} else {
					clearTimeout(timeout);
					document.title = "ðŸŽ‰ Welcome back!";
							setTimeout(function() {
								document.title = originalTitle;
							}, 2000);
				}
			});
		})();</script><script defer="defer" src="https://digitalheirloom.github.io/tools/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://digitalheirloom.github.io/tools/media/plugins/syntaxHighlighter/prism-line-numbers.min.js"></script><script defer="defer" src="https://digitalheirloom.github.io/tools/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://digitalheirloom.github.io/tools/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script></body></html>